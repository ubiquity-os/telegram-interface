name: Dual Bot Deployment

on:
  push:
    branches: ['**']  # Trigger on all branches

# Add permissions at the workflow level
permissions:
  id-token: write  # Required for OIDC token authentication
  contents: read   # Required for actions/checkout

jobs:
  production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        uses: denoland/deployctl@v1
        with:
          project: telegram-interface
          entrypoint: src/main.ts
          token: ${{ secrets.DENO_DEPLOY_TOKEN }}

  preview:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.43.0

      - name: Deploy preview
        uses: denoland/deployctl@v1
        with:
          project: telegram-interface-preview
          entrypoint: src/main.ts
          token: ${{ secrets.DENO_DEPLOY_TOKEN }}

      - name: Update preview webhook
        run: deno run --allow-net --allow-env scripts/update-preview-webhook.ts
        env:
          DENO_DEPLOY_TOKEN: ${{ secrets.DENO_DEPLOY_TOKEN }}
          PREVIEW_BOT_TOKEN: ${{ secrets.PREVIEW_BOT_TOKEN }}
          WEBHOOK_SECRET_PREVIEW: ${{ secrets.WEBHOOK_SECRET_PREVIEW }}