name: Deploy
on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: "1.43.x"

      - name: Install deployctl
        run: deno install -A -r https://deno.land/x/deploy/deployctl.ts

      - name: Set environment
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> $GITHUB_ENV
            echo "WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET_PRODUCTION }}" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=preview" >> $GITHUB_ENV
            echo "BOT_TOKEN=${{ secrets.PREVIEW_BOT_TOKEN }}" >> $GITHUB_ENV
            echo "WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET_PREVIEW }}" >> $GITHUB_ENV
          fi
          echo "DENO_DEPLOY_TOKEN=${{ secrets.DENO_DEPLOY_TOKEN }}" >> $GITHUB_ENV
          echo "DENO_PROJECT_NAME=telegram-interface" >> $GITHUB_ENV
          echo "DENO_PREVIEW_PROJECT_NAME=telegram-project-preview" >> $GITHUB_ENV

      - name: Verify Deno Deploy token
        run: |
          cd ci-simulation
          ./verify-token.sh $ENVIRONMENT

      - name: Deploy to Deno
        run: |
          cd ci-simulation
          ./deploy.sh $ENVIRONMENT

      - name: Update Telegram webhook
        run: |
          cd ci-simulation
          ./update-webhook.sh $ENVIRONMENT
